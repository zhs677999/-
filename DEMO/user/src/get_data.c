#include "zf_common_headfile.h"
#include "my_common.h"

// ------------------ ?????? (?????) ------------------

// ????????????
int16 encoder_data_1 = 0;
int16 encoder_data_2 = 0;
int16 encoder_data_3 = 0;
int16 encoder_data_4 = 0;

// ??????ADC????
uint8 channel_index = 0;
adc_channel_enum channel_list[ADC_CHANNEL_NUMBER] = 
{
    ADC_CHANNEL1, ADC_CHANNEL2, ADC_CHANNEL3, ADC_CHANNEL4,
};
uint16_t adc_buffer[ADC_CHANNEL_NUMBER];

// ??????????????
float adc_error;

// ------------------ ???????? ------------------
// ???????
uint8_t roundabout_detected = 0;
// ????,???????
uint16_t roundabout_timer = 0;
// ??????,??????????????
uint16_t roundabout_cooldown = 0;

// ?????????????
static uint16_t roundabout_active_time = 0;
static uint16_t roundabout_release_time = 0;

// -------------------------------------------------------------

// ???????
void get_encoder()
{
    encoder_data_1 = encoder_get_count(ENCODER_1);
    encoder_clear_count(ENCODER_1);

    encoder_data_2 = encoder_get_count(ENCODER_2);
    encoder_clear_count(ENCODER_2);
    
    encoder_data_3 = encoder_get_count(ENCODER_3);
    encoder_clear_count(ENCODER_3);

    encoder_data_4 = encoder_get_count(ENCODER_4);
    encoder_clear_count(ENCODER_4);
}

// ????ADC??
void get_adc()
{
    // ????4???
    for(channel_index = 0; channel_index < ADC_CHANNEL_NUMBER; channel_index ++)
    {
        adc_buffer[channel_index] = adc_convert(channel_list[channel_index]); 
    }
    
    // ????:????(0) - ????(3)
    // ??????,?????,error > 0
    // ??????,?????,error < 0
    adc_error = (float)(adc_buffer[0] - adc_buffer[3]);
}

// ????????????????
// ????????(??? 1/2 ??),?????,??????????
void roundabout_detect(void)
{
    // ?????? ADC ????
    uint8_t roundabout_pattern = (adc_buffer[1] > ROUNDABOUT_THRESHOLD) && (adc_buffer[2] > ROUNDABOUT_THRESHOLD);

    // ??????????????,????????????
    if(roundabout_cooldown)
    {
        roundabout_cooldown--;
    }

    // --- ????? ---
    if(roundabout_detected)
    {
        // ??????????????Ë²???????
        if(roundabout_active_time < UINT16_MAX)
        {
            roundabout_active_time++;
        }

        // ??? hold ?????????????
        if(roundabout_active_time < ROUNDABOUT_HOLD_TIME)
        {
            roundabout_release_time = 0;
            return;
        }

        // ??????????????????????,??????????
        if(roundabout_pattern)
        {
            roundabout_release_time = 0;
            return;
        }

        // ????,???????,??????
        if(++roundabout_release_time >= ROUNDABOUT_DEBOUNCE)
        {
            roundabout_detected = 0;
            roundabout_release_time = 0;
            roundabout_active_time = 0;
            roundabout_timer = 0;
            roundabout_cooldown = ROUNDABOUT_COOLDOWN;
        }

        return;
    }

    // --- ????? ---
    if(roundabout_cooldown)
    {
        roundabout_timer = 0;
        roundabout_active_time = 0;
        roundabout_release_time = 0;
        return;
    }

    // ????????
    if(roundabout_pattern)
    {
        if(++roundabout_timer >= ROUNDABOUT_DEBOUNCE)
        {
            roundabout_detected = 1;
            roundabout_active_time = 0;
            roundabout_release_time = 0;
        }
    }
    else
    {
        roundabout_timer = 0;
    }
}

// ????????
void get_data()
{
    get_encoder();
    get_adc();

    roundabout_detect();  // ????????,????
}
